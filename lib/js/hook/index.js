"use strict";const e=require("fs"),i=require("path"),t=require("shelljs"),{warning:n,getCurrent:o,getLogs:s,compareVersion:r}=require("../index"),{hookList:c}=require("../global"),l=require("../gitRevParse"),u=require("../getGitVersion"),a=require("./getHookComment"),g=require("./getHookType"),f=require("./getHookShell"),h=require("./getLocalShell"),m=require("ci-info"),p=require("../getConfig"),S=o(),{gitHookDir:d,prefix:y}=l(),k=u(),x=p();module.exports={init:function(){const o=k&&r(k,"2.13.0");m.isCI&&x.skipCI?console.info("持续集成环境，跳过钩子安装"):(e.existsSync(d)||e.mkdirSync(d),["1","true"].includes(process.env.GITMARS_SKIP_HOOKS||"")&&(t.echo(n("已存在环境变量GITMARS_SKIP_HOOKS，跳过安装")),process.exit(0)),o||(t.echo(n("Gitmars需要使用2.13.0以上版本的Git，当前版本："+k)),process.exit(0)),function(t=d){const n=(i,t)=>{e.writeFileSync(i,t,"utf-8"),e.chmodSync(i,493)};c.map((e=>i.join(t,e))).forEach((t=>{const o=`#!/bin/sh\n# gitmars\n\n${a()}\n\n. "$(dirname "$0")/gitmars.sh"`,s=i.basename(t);if(e.existsSync(t)){const i=e.readFileSync(t,"utf-8");return g.isGhooks(i)?(console.info(`合并已存在的ghooks钩子: ${s}`),n(t,o)):g.isPreCommit(i)?(console.info(`合并已存在的pre-commit钩子: ${s}`),n(t,o)):g.isGitmars(i)||g.isHusky(i)||g.isYorkie(i)?n(t,o):void console.info(`跳过已存在的用户git钩子: ${s}`)}n(t,o)}))}(d),function(t=d){let n=i.join(t,"gitmars.sh");e.writeFileSync(n,f(),"utf-8"),e.chmodSync(n,493)}(d),function(t=d,n,o){let s=i.join(t,"gitmars.local.sh");e.writeFileSync(s,h(n,o),"utf-8"),e.chmodSync(s,493)}(d,"yarn",y),console.info("gitmars hooks init down"))},remove:function(){!function(t=d){c.map((e=>i.join(t,e))).filter((i=>{if(e.existsSync(i)){const t=e.readFileSync(i,"utf-8");return g.isGitmars(t)}return!1})).forEach((i=>{e.unlinkSync(i)}))}(),function(t=d){const n=i.join(t,"gitmars.sh");e.existsSync(n)&&e.unlinkSync(n)}(),function(t=d){const n=i.join(t,"gitmars.local.sh");e.existsSync(n)&&e.unlinkSync(n)}(),console.info("gitmars hooks removed")},getIsMergedBranch:function(e=S,i="dev"){return t.exec(`git branch --contains ${e}`,{silent:!0}).stdout.replace(/[\s]*$/g,"").split("\n").includes(i)},getIsUpdatedInTime:function({latest:e,limit:i,branch:t}){let n=!1,o=[],r=[];const c=s({latest:e,limit:i,branches:t}),l=s({latest:e,limit:i,branches:S});c.forEach((e=>{o.push(e["%H"])})),l.forEach((e=>{(e["%P"]?e["%P"].split(" "):[]).forEach((e=>{r.push(e)}))}));e:for(let e of o)if(r.includes(e)){n=!0;break e}return n},getIsMergeAction:function(){const e=s({limit:1,branches:S});return(e[0]["%P"]?e[0]["%P"].split(" "):[]).length>1},getBehandLogs:function(){t.exec("git fetch",{silent:!0});const e=t.exec(`git log ${S}..origin/${S} --pretty=format:"%p"`,{silent:!0}).stdout.replace(/[\s]*$/g,"");return e?e.split("\n"):[]},getAheadLogs:function(){t.exec("git fetch",{silent:!0});const e=t.exec(`git log origin/${S}..${S} --pretty=format:"%p"`,{silent:!0}).stdout.replace(/[\s]*$/g,"");return e?e.split("\n"):[]}};
