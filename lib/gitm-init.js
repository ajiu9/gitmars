#!/usr/bin/env node
"use strict";var fs=require("fs");var path=require("path");var program=require("commander");var sh=require("shelljs");var inquirer=require("inquirer");var _require=require("./js/index"),success=_require.success;var _require2=require("./js/global"),defaults=_require2.defaults;var _require3=require("./js/gitRevParse")(),root=_require3.root;program.name("gitm init").usage("").description("设置gitmars的配置项").action(function(){var prompts=[];Object.keys(defaults).forEach(function(key){if(["master","develop","release","bugfix","support"].includes(key)){prompts.push({type:"input",name:key,message:"请输入".concat(key,"分支名称"),default:function _default(){return key},transformer:function transformer(val,answers,flags){return val.trim()},validate:function validate(val){return/^\w+$/.test(val)?true:"请输入可用名称"}})}else if(key==="user"){prompts.push({type:"input",name:key,message:"请输入Git用户名",transformer:function transformer(val,answers,flags){return val.trim()},validate:function validate(val){return val===""||/^\w+$/.test(val)?true:"请输入可用名称"}})}else if(key==="email"){prompts.push({type:"input",name:key,message:"请输入Git邮箱",transformer:function transformer(val,answers,flags){return val.trim()},validate:function validate(val){return val===""||/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(val)?true:"请输入正确的邮箱"}})}else if(key==="msgTemplate"){prompts.push({type:"input",name:key,message:"请输入消息模板",default:function _default(){return"${message}；项目：${project}；路径：${pwd}"},transformer:function transformer(val,answers,flags){return val.trim()}})}else if(key==="msgUrl"){prompts.push({type:"input",name:key,message:"请输入云之家消息推送地址",transformer:function transformer(val,answers,flags){return val.trim()},validate:function validate(val){return val===""||/^https?:\/\/[\S]*$/.test(val)?true:"请输入网址"}})}else if(key==="apolloConfig"){prompts.push({type:"editor",name:key,message:"请输入apollo配置",default:function _default(){return'{\n    "configServerUrl": "",\n    "appId": "",\n    "clusterName": "",\n    "namespaceName": [],\n    "apolloEnv": "",\n    "token": ""\n}'},validate:function validate(val){try{val=JSON.parse(val);return true}catch(e){return"请输入json"}}})}else if(key==="hooks"){prompts.push({type:"editor",name:key,message:"请输入hooks配置",default:function _default(){return'{\n    "pre-commit": "",\n    "pre-push": ""\n}'},validate:function validate(val){try{val=JSON.parse(val);return true}catch(e){return"请输入json"}}})}else if(key==="api"){prompts.push({type:"input",name:key,message:"请输入查询用户权限接口",transformer:function transformer(val,answers,flags){return val.trim()},validate:function validate(val){return val===""||/^https?:\/\/[\S]*$/.test(val)?true:"请输入网址"}})}else if(key==="gitHost"){prompts.push({type:"input",name:key,message:"请输入git网址",transformer:function transformer(val,answers,flags){return val.trim()},validate:function validate(val){return val===""||/^https?:\/\/[\S]*$/.test(val)?true:"请输入网址"}})}else if(key==="gitID"){prompts.push({type:"input",name:key,message:"请输入git项目ID，目前仅支持gitlab",transformer:function transformer(val,answers,flags){return val.trim()},validate:function validate(val){return val===""||/^\d+$/.test(val)?true:"请输入网址"}})}});inquirer.prompt(prompts).then(function(answers){try{answers.apolloConfig=JSON.parse(answers.apolloConfig);if(!answers.apolloConfig.configServerUrl||!answers.apolloConfig.token)answers.apolloConfig=""}catch(e){answers.apolloConfig=""}try{var valid=false;answers.hooks=JSON.parse(answers.hooks);hooks:for(var k in answers.hooks){if(!!answers.hooks[k]){valid=true;break hooks}}if(!valid)answers.hooks=""}catch(e){answers.hooks=""}sh.echo(success("gitmars配置成功"));fs.writeFileSync(root+"/.gitmarsrc",JSON.stringify(answers,null,4),"utf-8");fs.chmodSync(root+"/.gitmarsrc",493)})});program.parse(process.argv);