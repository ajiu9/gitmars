#!/usr/bin/env node
"use strict";require("core-js/modules/es.symbol.js");require("core-js/modules/es.symbol.description.js");require("core-js/modules/es.array.for-each.js");require("core-js/modules/es.function.name.js");require("core-js/modules/es.object.to-string.js");require("core-js/modules/es.promise.js");require("core-js/modules/es.regexp.exec.js");require("core-js/modules/es.regexp.flags.js");require("core-js/modules/es.string.split.js");require("core-js/modules/web.dom-collections.for-each.js");require("regenerator-runtime/runtime.js");function _createForOfIteratorHelper(o,allowArrayLike){var it;if(typeof Symbol==="undefined"||o[Symbol.iterator]==null){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function s(){it=o[Symbol.iterator]()},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e2){didErr=true;err=_e2},f:function f(){try{if(!normalCompletion&&it.return!=null)it.return()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}var program=require("commander");var sh=require("shelljs");var _require=require("./conf/hook"),options=_require.options,args=_require.args;var _require2=require("./js/index"),error=_require2.error,createArgs=_require2.createArgs;var _require3=require("./js/hook"),init=_require3.init,remove=_require3.remove,getIsMergedBranch=_require3.getIsMergedBranch,getIsUpdatedInTime=_require3.getIsUpdatedInTime,getIsMergeAction=_require3.getIsMergeAction,getBehandLogs=_require3.getBehandLogs,getAheadLogs=_require3.getAheadLogs;var config=require("./js/getConfig")();program.name("gitm hook").usage("[command]").description("git hook钩子");if(args.length>0)program.arguments(createArgs(args));options.forEach(function(o){program.option(o.flags,o.description,o.defaultValue)});program.action(function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(command,args,opt){var behandLogs,aheadLogs,isMerge,_iterator,_step,logStr,logs;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!opt.noVerify){_context.next=3;break}sh.exit(0);return _context.abrupt("return");case 3:if(!(command==="init")){_context.next=7;break}init();_context.next=44;break;case 7:if(!(command==="remove")){_context.next=11;break}remove();_context.next=44;break;case 11:if(!(opt.type==="1")){_context.next=14;break}_context.next=44;break;case 14:if(!(opt.type==="2")){_context.next=17;break}_context.next=44;break;case 17:if(!(opt.type==="3")){_context.next=43;break}behandLogs=getBehandLogs();aheadLogs=getAheadLogs();isMerge=true;_iterator=_createForOfIteratorHelper(aheadLogs);_context.prev=22;_iterator.s();case 24:if((_step=_iterator.n()).done){_context.next=32;break}logStr=_step.value;logs=logStr.split(" ");if(!(logs.length<2)){_context.next=30;break}isMerge=false;return _context.abrupt("break",32);case 30:_context.next=24;break;case 32:_context.next=37;break;case 34:_context.prev=34;_context.t0=_context["catch"](22);_iterator.e(_context.t0);case 37:_context.prev=37;_iterator.f();return _context.finish(37);case 40:if(isMerge){sh.exit(0)}else{sh.echo(error("不允许在主干分支直接更改代码提交，请联系管理员"));sh.exit(1)}_context.next=44;break;case 43:if(opt.type==="4"){}case 44:sh.exit(1);case 45:case"end":return _context.stop()}}},_callee,null,[[22,34,37,40]])}));return function(_x,_x2,_x3){return _ref.apply(this,arguments)}}());program.parse(process.argv);