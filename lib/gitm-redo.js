#!/usr/bin/env node
"use strict";const{program:e}=require("commander"),r=require("inquirer"),s=require("shelljs"),{options:t,args:c}=require("./conf/redo"),{error:i,warning:o,queue:a,isGitProject:n}=require("./js/index"),{createArgs:m}=require("./js/tools");n()||(s.echo(i("当前目录不是git项目目录")),s.exit(1)),e.name("gitm redo").usage("[commitid...] [-b --branch [branch]] [-m --mode [mode]]").description("撤销一次提交记录"),c.length>0&&e.arguments(m(c)),t.forEach((r=>{e.option(r.flags,r.description,r.defaultValue)})),e.action((async(e,t)=>{const c=[];let i="";if(t.mode&&(i=" -m "+Math.abs(Number(t.mode))),t.branch){const e=["%H","%aI","%an"],o=s.exec(`git log --merges --grep="'${t.branch}'" --date-order --pretty=format:"${e.join(",=")}-end-"`,{silent:!0}).stdout.replace(/[\r\n]+/g,"").replace(/-end-$/,""),a=[];let n=a.map((e=>e["%H"]));if(o&&o.split("-end-").forEach((r=>{const s=r.split(",="),t={};e.forEach(((e,r)=>{t[e]=s[r]})),a.push(t)})),a.reverse(),a.length>1){const e={type:"checkbox",message:"检测到存在多条记录，请选择要撤销的项",name:"commitIDs",choices:[]};a.forEach((r=>{e.choices.push({name:`${r["%an"]}操作于：${r["%aI"]}`,value:r["%H"],checked:!0})}));const{commitIDs:s}=await r.prompt(e);n=s}n.forEach((e=>{c.push({cmd:`git revert ${e}${i}`,config:{slient:!1,again:!0,success:"撤销成功",fail:"出错了，请根据提示处理"}})}))}else e?c.push({cmd:`git revert ${e}${i}`,config:{slient:!1,again:!0,success:"撤销成功",fail:"出错了，请根据提示处理"}}):(s.echo(o("指令不合法")),s.exit(1));a(c)})),e.parse(process.argv);
